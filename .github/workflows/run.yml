name: Run Webook Bot

on:
  workflow_dispatch:
    inputs:
      days:
        description: "كم يوم تحجز؟ (مثال: 5)"
        required: false
        default: "5"
      time_text:
        description: "نص الوقت في الموقع (مثال: 08:00 PM)"
        required: false
        default: ""
      tickets:
        description: "عدد التذاكر (مثال: 5)"
        required: false
        default: "5"

jobs:
  run-bot:
    runs-on: ubuntu-latest
    steps:
      - name: تنزيل الملفات
        uses: actions/checkout@v4

      - name: إعداد Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: تثبيت التبعيات اللازمة للنظام (متوافقة مع ubuntu-latest)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libasound2t64 libatk1.0-0 libatk-bridge2.0-0 libcups2 \
            libdbus-1-3 libdrm2 libxcomposite1 libxdamage1 libxfixes3 \
            libxrandr2 libgbm1 libgtk-3-0 libpango-1.0-0 libnss3 \
            fonts-liberation libxshmfence1 xvfb

      - name: تثبيت مكتبات Python + Playwright
        run: |
          pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install playwright
          python -m playwright install --with-deps chromium

      - name: تشغيل البوت (يدويًا)
        env:
          WEBOOK_EMAIL: ${{ secrets.WEBOOK_EMAIL }}
          WEBOOK_PASSWORD: ${{ secrets.WEBOOK_PASSWORD }}
          DAYS: ${{ github.event.inputs.days }}
          TIME_TEXT: ${{ github.event.inputs.time_text }}
          TICKET_COUNT: ${{ github.event.inputs.tickets }}
          PYTHONUNBUFFERED: "1"
        run: |
          set -x
          mkdir -p artifacts
          # شغّل تحت Xvfb عشان المتصفح يشتغل في CI
          xvfb-run -a python webook_bot.py | tee artifacts/bot.log

      - name: رفع لوجات/مخرجات للتشخيص
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-artifacts
          path: artifacts
